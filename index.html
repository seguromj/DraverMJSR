
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("MJSR App configurado com sucesso!"));
  }
</script>


    
    <title>MJSR Pro 5.0.3</title>
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-green: #39ff14;
            --dark-bg: #0a0b10;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --uber-color: #000000;
            --99-color: #f7b500;
            --part-color: #007bff;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--dark-bg);
            background-image: radial-gradient(circle at top, #1a1b25 0%, #0a0b10 100%);
            color: #e0e0e0;
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            transition: background 0.3s;
        }

        /* Estilo Modo AMOLED */
        body.amoled-mode {
            background: #000000 !important;
            background-image: none !important;
        }

        .header {
            text-align: center;
            padding: 20px;
            border: 1px solid var(--neon-blue);
            border-radius: 20px;
            box-shadow: 0 0 15px var(--neon-blue);
            margin-bottom: 20px;
            background: var(--glass);
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
            min-width: 70px;
        }
        .badge-uber { background-color: var(--uber-color); color: white; border: 1px solid #444; }
        .badge-99 { background-color: var(--99-color); color: black; }
        .badge-particular { background-color: var(--part-color); color: white; }
        .badge-gasto { background-color: #ff4444; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--neon-purple);
            padding: 12px;
            border-radius: 8px;
        }
        .stat-label { font-size: 9px; color: #aaa; text-transform: uppercase; }
        .stat-value { font-size: 16px; font-weight: bold; display: block; margin-top: 4px; }

        input, select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        .btn {
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        .btn-main { background: var(--neon-blue); color: #000; }
        .btn-pix { background: #32bcad; color: white; }

        .modal-full {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }
        #modal-pix img {
            max-width: 90%;
            max-height: 70vh;
            object-fit: contain;
            border-radius: 10px;
            border: 3px solid var(--neon-green);
            box-shadow: 0 0 20px var(--neon-green);
        }

        .history-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .history-table td { padding: 10px 5px; border-bottom: 1px solid var(--glass-border); }

        .btn-delete {
            background: none;
            border: 1px solid #ff4444;
            color: #ff4444;
            border-radius: 5px;
            padding: 2px 8px;
            cursor: pointer;
            font-weight: bold;
        }

        #modal-trava, #modal-aviso-final {
            z-index: 3000;
            background: #000;
        }

        /* Estilo para o status da imagem */
        .status-imagem-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }

        /* Estilo da Miniatura */
        #thumb-pix {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            border: 1px solid var(--neon-green);
            object-fit: cover;
        }

        /* Estilo Bot√£o Voltar do Modal */
        .btn-voltar-modal {
            margin-top: 20px;
            padding: 10px 30px;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 30px;
            font-weight: bold;
            text-transform: uppercase;
            background: rgba(0, 243, 255, 0.1);
            box-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- ESTILOS PLANILHA MENSAL --- */
        .semana-container {
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.02);
        }
        .semana-titulo {
            color: var(--neon-blue);
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 8px;
            display: block;
            text-align: left;
        }
        .grid-dias {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .dia-box { position: relative; }
        .dia-box label { font-size: 9px; color: #888; display: block; text-align: left; }
        .dia-box input { padding: 5px; font-size: 11px; margin-bottom: 5px; padding-right: 18px; }
        
        /* Bot√£o de Hist√≥rico no Dia */
        .btn-hist-dia {
            position: absolute;
            right: 2px;
            bottom: 8px;
            background: var(--neon-blue);
            color: #000;
            border: none;
            border-radius: 3px;
            font-size: 8px;
            width: 14px;
            height: 14px;
            cursor: pointer;
            font-weight: bold;
        }

        #modal-metas .card {
            max-height: 85vh;
            overflow-y: auto;
            width: 95%;
        }

        .btn-lancar {
            background: var(--neon-green);
            color: black;
            font-size: 10px;
            padding: 5px;
            margin-top: 5px;
            border-radius: 5px;
            width: 100%;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }

        /* Barra de Meta Di√°ria */
        .meta-container { margin: 10px 0; }
        .meta-bar-bg { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .meta-bar-fill { height: 100%; width: 0%; transition: width 0.5s, background 0.5s; }

        /* Modal Interno de Hist√≥rico */
        #modal-detalhe-hist {
            z-index: 4000;
            background: rgba(0,0,0,0.98);
        }

        /* --- NOVOS ESTILOS PARA AS 6 ALTERA√á√ïES --- */
        .alert-oil {
            background: #ff4444;
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            margin-top: 5px;
            text-align: center;
            display: none;
            animation: blink 1s infinite;
        }
        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.3;} 100% {opacity: 1;} }

        .simulador-resultado {
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
            display: none;
        }

        .chart-container {
            display: flex;
            align-items: flex-end;
            gap: 5px;
            height: 100px;
            margin-top: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }
        .chart-bar {
            flex: 1;
            background: var(--neon-blue);
            border-radius: 3px 3px 0 0;
            position: relative;
            min-height: 2px;
        }
        .chart-label {
            font-size: 7px;
            position: absolute;
            top: -15px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="modal-login" class="modal-full" style="display: flex;">
        <div class="card" style="width: 100%; max-width: 300px;">
            <h2 style="color: var(--neon-blue);">ACESSO MJSK</h2>
            <input type="text" id="login-nome" placeholder="Seu Nome">
            <input type="number" id="login-whatsapp" placeholder="WhatsApp">
            <button class="btn btn-main" onclick="entrarServico()">Entrar no Servi√ßo</button>
        </div>
    </div>

    <div id="modal-trava" class="modal-full">
        <div class="card" style="width: 100%; max-width: 300px; border: 2px solid var(--neon-purple);">
            <h2 style="color: var(--neon-purple);">SISTEMA BLOQUEADO</h2>
            <p id="msg-trava" style="font-size: 12px; margin-bottom: 15px;">Insira as credenciais para continuar</p>
            <input type="text" id="trava-id" placeholder="ID">
            <input type="password" id="trava-senha" placeholder="SENHA">
            <button class="btn btn-main" onclick="validarAcesso()">Desbloquear</button>
            <button class="btn" style="background:#25d366; color:#fff;" onclick="solicitarAcesso()">Quero ter o ID e Senha</button>
        </div>
    </div>

    <div id="modal-aviso-final" class="modal-full">
        <div class="card" style="width: 100%; max-width: 300px; border: 2px solid #ff4444;">
            <h2 style="color: #ff4444;">AVISO DE EXPIRA√á√ÉO</h2>
            <p style="font-size: 14px; margin-bottom: 15px;">Aten√ß√£o! Faltam apenas 10 minutos para o sistema ser bloqueado permanentemente.</p>
            <p style="font-size: 12px; color: #aaa;">Para continuar usando, entre em contato agora para efetuar o pagamento.</p>
            <button class="btn" style="background:#25d366; color:#fff;" onclick="solicitarAcesso()">PAGAR AGORA (WHATSAPP)</button>
            <button class="btn" style="background:#444; color:#fff;" onclick="document.getElementById('modal-aviso-final').style.display='none'">ENTENDI</button>
        </div>
    </div>

    <div class="header">
        <h2 style="margin:0; color:var(--neon-blue); letter-spacing:2px;">MJSR PRO <span style="font-size: 10px;"> 5.0.3</span></h2>
        <span id="user-logged" style="font-size: 10px; color: var(--neon-green);"></span>
        <div id="display-validade" style="font-size: 10px; color: #ff4444; margin-top: 5px; font-weight: bold;"></div>
        
        <button onclick="toggleAmoled()" style="background:none; border:1px solid #444; color:#888; font-size:9px; padding:3px 8px; border-radius:10px; margin-top:10px;">Modo AMOLED (Bateria)</button>
    </div>

    <div id="modal-whats-dest" class="modal-full">
        <div class="card" style="width: 100%; max-width: 300px; border: 1px solid #25d366;">
            <h2 style="color: #25d366; font-size: 18px;">ENVIAR RELAT√ìRIO</h2>
            <p style="font-size: 11px; color: #aaa; margin-bottom: 15px;">Digite o WhatsApp de destino (com DDD):</p>
            <input type="number" id="whats-destino" placeholder="Ex: 62999999999">
            <button class="btn" style="background: #25d366; color: white;" onclick="confirmarEnvioWhats()">Enviar Agora</button>
            <button class="btn" style="background: #444; color: #fff;" onclick="document.getElementById('modal-whats-dest').style.display='none'">Cancelar</button>
        </div>
    </div>

    <div id="modal-metas" class="modal-full">
        <div class="card" style="max-width: 350px; border: 1px solid var(--neon-green);">
            <h2 style="color: var(--neon-green); font-size: 16px; margin-top: 0;">PLANILHA MENSAL</h2>
            
            <div id="container-semanas"></div>

            <div class="stat-box" style="border-left-color: var(--neon-green); margin-bottom: 15px;">
                <span class="stat-label">TOTAL ACUMULADO M√äS</span>
                <span class="stat-value" id="resumo-mes" style="font-size: 18px; color: var(--neon-green);">R$ 0,00</span>
            </div>

            <span class="stat-label">Desempenho por Semana</span>
            <div class="chart-container">
                <div class="chart-bar" id="bar-s1"><span class="chart-label" id="lbl-s1"></span></div>
                <div class="chart-bar" id="bar-s2"><span class="chart-label" id="lbl-s2"></span></div>
                <div class="chart-bar" id="bar-s3"><span class="chart-label" id="lbl-s3"></span></div>
                <div class="chart-bar" id="bar-s4"><span class="chart-label" id="lbl-s4"></span></div>
            </div>
            
            <button class="btn" style="background: #900; color: #fff; font-size: 10px; padding: 10px;" onclick="resetarPlanilhaMensal()">Zerar Tudo (Mensal)</button>
            <button class="btn btn-main" style="background: var(--neon-green);" onclick="salvarMetasMensais()">Aplicar e Salvar</button>
            <button class="btn" style="background: #444; color: #fff;" onclick="document.getElementById('modal-metas').style.display='none'">Voltar</button>
        </div>
    </div>

    <div id="modal-detalhe-hist" class="modal-full">
        <div class="card" style="width: 90%; max-width: 320px; border: 1px solid var(--neon-blue);">
            <h3 id="titulo-hist-dia" style="color: var(--neon-blue); font-size: 14px;">HIST√ìRICO DO DIA</h3>
            <div style="max-height: 250px; overflow-y: auto; text-align: left;">
                <table class="history-table" id="tabela-detalhe-dia">
                    <tbody id="corpo-detalhe-dia"></tbody>
                </table>
            </div>
            <button class="btn btn-main" style="margin-top:15px;" onclick="document.getElementById('modal-detalhe-hist').style.display='none'">Fechar</button>
        </div>
    </div>

    <div class="card" style="border-color: var(--neon-purple);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span class="stat-label">Jornada de Trabalho</span>
            <span id="timer-display" style="font-family: monospace; font-weight: bold; color: var(--neon-purple);">00:00:00</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <button id="btn-timer-start" class="btn" style="background: var(--neon-purple); font-size: 10px; margin-bottom: 0;" onclick="toggleTurno()">Iniciar Turno</button>
            <div class="stat-box" style="padding: 5px; border-left-color: var(--neon-purple);">
                <span class="stat-label">Ganho/Hora</span>
                <span class="stat-value" id="ganho-hora" style="font-size: 12px;">R$ 0,00</span>
            </div>
        </div>
    </div>

    <div class="card">
        <span class="stat-label">Configurar Meta Di√°ria (R$)</span>
        <input type="number" id="input-meta-diaria" placeholder="Ex: 200" oninput="atualizarDash()">
        <div class="meta-container">
            <span class="stat-label" id="label-progresso">Progresso: 0%</span>
            <div class="meta-bar-bg">
                <div id="barra-meta" class="meta-bar-fill"></div>
            </div>
        </div>
    </div>

    <div class="card" style="border-color: #ff4444;">
        <span class="stat-label">Troca de √ìleo (KM)</span>
        <div style="display: flex; gap: 10px; margin-top: 5px;">
            <input type="number" id="km-ultima-troca" placeholder="KM da Troca" oninput="checkManutencao()">
            <input type="number" id="km-intervalo" placeholder="A cada (Ex: 1000)" value="1000" oninput="checkManutencao()">
        </div>
        <div id="aviso-oleo" class="alert-oil">‚ö†Ô∏è HORA DE TROCAR O √ìLEO!</div>
    </div>

    <div class="card">
        <span class="stat-label">QR Code da Galeria</span>
        <input type="file" id="input-foto-pix" accept="image/*">
        <div id="status-imagem-pix" class="status-imagem-container" style="display: none;">
            <img id="thumb-pix" src="" alt="Thumbnail">
            <span style="color: var(--neon-green); font-weight: bold; font-size: 13px;">Imagem ‚úÖ</span>
            <button class="btn-delete" onclick="removerFotoPix()">Excluir</button>
        </div>
    </div>

    <div id="modal-pix" class="modal-full" onclick="this.style.display='none'">
        <img id="img-qr-exibicao" src="" alt="QR Code">
        <div class="btn-voltar-modal">TOQUE PARA VOLTAR</div>
    </div>

    <div class="stats-grid">
        <div class="stats-box">
            <span class="stat-label">Bruto Total</span>
            <span class="stat-value" id="total-bruto" style="color:var(--neon-green);">R$ 0,00</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--neon-blue);">
            <span class="stat-label">Cofre Manuten√ß√£o (10%)</span>
            <span class="stat-value" id="cofre-manutencao" style="color:var(--neon-blue);">R$ 0,00</span>
        </div>
    </div>
    
    <div class="stats-grid" style="margin-top: 10px;">
        <div class="stat-box" style="border-left-color: #ff4444;">
            <span class="stat-label">Total Gasto</span>
            <span class="stat-value" id="total-gasto" style="color:#ff4444;">R$ 0,00</span>
        </div>
        <div class="stat-box" style="border-left-color: var(--neon-green);">
            <span class="stat-label">Lucro L√≠quido</span>
            <span class="stat-value" id="lucro-real" style="color:var(--neon-green);">R$ 0,00</span>
            <button class="btn-lancar" onclick="abrirSeletorLancamento()">Lan√ßar no Mensal</button>
        </div>
    </div>

    <div class="card" style="margin-top: 10px; border-left: 3px solid #39ff14; padding: 10px;">
        <span class="stat-label">Efici√™ncia (Lucro / KM)</span>
        <span class="stat-value" id="lucro-por-km" style="color: #39ff14; font-size: 14px;">R$ 0,00 / KM</span>
    </div>

    <div class="card" style="border-color: #39ff14;">
        <span class="stat-label" style="color: #39ff14;">Simulador: Vale a Pena?</span>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
            <div class="dia-box">
                <label style="color: #39ff14;">Min Verde (R$/KM)</label>
                <input type="number" id="limit-verde" value="2.0" step="0.1" oninput="simularCorrida()">
            </div>
            <div class="dia-box">
                <label style="color: #f7b500;">Min Amarelo (R$/KM)</label>
                <input type="number" id="limit-amarelo" value="1.2" step="0.1" oninput="simularCorrida()">
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
            <input type="number" id="sim-valor" placeholder="Valor (R$)" oninput="simularCorrida()">
            <input type="number" id="sim-km" placeholder="KM Total" oninput="simularCorrida()">
        </div>
        <div id="sim-resultado" class="simulador-resultado"></div>
    </div>

    <div class="card" style="margin-top:15px; border: 1px solid #f7b500;">
        <span class="stat-label" style="color:#f7b500;">Calculadora de Combust√≠vel</span>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-top:5px;">
            <input type="number" id="calc-preco" placeholder="Litro R$" step="0.01" oninput="calcularCombustivel()">
            <input type="number" id="calc-gasto" placeholder="Gastei R$" step="0.01" oninput="calcularCombustivel()">
            <input type="number" id="calc-kml" placeholder="Faz KM/L" step="0.1" oninput="calcularCombustivel()">
        </div>
        <div id="resultado-combustivel" style="font-size: 10px; color: #aaa; text-align: center;">Preencha os campos para calcular a meta de KM.</div>
    </div>

    <div class="card" style="margin-top:15px;">
        <select id="tipo" onchange="toggleCampos()">
            <option value="corrida">Nova Corrida</option>
            <option value="despesa">Nova Despesa</option>
        </select>

        <div id="campos-corrida">
            <input type="number" id="valor" placeholder="Valor Ganho (R$)" step="0.01">
            <input type="number" id="km-manual" placeholder="KM Percorrido">
            <select id="plataforma">
                <option value="Uber">Uber</option>
                <option value="99">99 App</option>
                <option value="Particular">Particular</option>
            </select>
        </div>

        <div id="campos-despesa" style="display:none">
            <input type="number" id="valor-gasto" placeholder="Valor do Gasto (R$)">
            <input type="text" id="desc-gasto" placeholder="Descri√ß√£o">
        </div>

        <button class="btn btn-main" onclick="salvarRegistro()">Salvar na Planilha</button>
        <button class="btn" style="background: var(--neon-purple); color: white;" onclick="abrirModalMetas()">Metas Semana/M√™s</button>
        <button class="btn btn-pix" onclick="abrirModal()">Mostrar QR Code PIX</button>
        
        <button class="btn" style="background: #333; color: white;" onclick="exportarRelatorioPDF()">Baixar Planilha (Excel/CSV)</button>
        
        <button class="btn" style="background: #25d366; color: white;" onclick="enviarRelatorioWhats()">Relat√≥rio Di√°rio (WhatsApp)</button>
    </div>

    <div class="card">
        <span class="stat-label">KM Total do Dia</span>
        <span class="stat-value" id="total-km" style="color:var(--neon-blue); font-size: 14px;">0.0 KM</span>
        <hr style="opacity: 0.1; margin: 10px 0;">
        <span class="stat-label">Hist√≥rico Recente</span>
        <table class="history-table">
            <tbody id="lista-historico"></tbody>
        </table>
    </div>

    <button class="btn" style="background:#300; color:#f44; border:1px solid #f44;" onclick="resetar()">Apagar Dados de Hoje</button>


<div id="container-instalacao" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 80%; max-width: 300px; background: rgba(0,0,0,0.95); padding: 30px 20px; text-align: center; border: 1px solid #d4af37; border-radius: 15px; z-index: 10000; box-shadow: 0 0 20px rgba(0,0,0,0.8);">
    <p style="color: #fff; margin: 0 0 20px 0; font-family: sans-serif; font-size: 16px; line-height: 1.5;">Leve a <strong>MJSR Pro 5.0.3</strong> no seu bolso! <br>Instale nosso App. üèçÔ∏èüöó</p>
    
    <button id="btnInstalarApp" style="width: 100%; background-color: #fff; color: #000; border: none; padding: 12px; border-radius: 5px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 12px; margin-bottom: 10px;">
        Instalar Agora
    </button>
    
    <button id="btnRecusarApp" style="width: 100%; background-color: transparent; color: #aaa; border: none; padding: 10px; cursor: pointer; text-decoration: underline; font-size: 11px;">
        Agora n√£o
    </button>
</div>

    <script>
        let registros = JSON.parse(localStorage.getItem('mjsk_data_v5')) || [];
        
        let planilhaMensal = JSON.parse(localStorage.getItem('mjsk_planilha_mensal')) || {
            s1: [0,0,0,0,0,0,0],
            s2: [0,0,0,0,0,0,0],
            s3: [0,0,0,0,0,0,0],
            s4: [0,0,0,0,0,0,0]
        };

        let historicoMensal = JSON.parse(localStorage.getItem('mjsk_hist_mensal')) || {
            s1: [[],[],[],[],[],[],[]],
            s2: [[],[],[],[],[],[],[]],
            s3: [[],[],[],[],[],[],[]],
            s4: [[],[],[],[],[],[],[]]
        };

        // --- VARI√ÅVEIS DO CRON√îMETRO ---
        let tempoInicio = localStorage.getItem('mjsk_inicio_turno') || null;
        let timerInterval = null;

        const motoboy = JSON.parse(localStorage.getItem('mjsk_motorista'));
        if(motoboy) {
            document.getElementById('modal-login').style.display = 'none';
            document.getElementById('user-logged').innerText = "Motorista: " + motoboy.nome;
            iniciarCronometro(); 
            iniciarContagemMensal();
            if(tempoInicio) iniciarRelogioTurno();
        }

        function entrarServico() {
            const n = document.getElementById('login-nome').value;
            const w = document.getElementById('login-whatsapp').value;
            if(n && w) {
                localStorage.setItem('mjsk_motorista', JSON.stringify({nome: n, whatsapp: w}));
                location.reload();
            } else { alert("Preencha Nome e Whats!"); }
        }

        function iniciarCronometro() {
            const liberadoPermanente = localStorage.getItem('mjsk_liberado_permanente') === 'true';
            if (!liberadoPermanente) {
                setTimeout(function() {
                    if (localStorage.getItem('mjsk_liberado_permanente') !== 'true') {
                        document.getElementById('modal-trava').style.display = 'flex';
                    }
                }, 120000); 
            }
        }

        function validarAcesso() {
            const id = document.getElementById('trava-id').value;
            const pass = document.getElementById('trava-senha').value;
            if (id === "111219" && pass === "111219") { 
                localStorage.setItem('mjsk_liberado_permanente', 'true');
                if (!localStorage.getItem('mjsk_expiracao')) {
                    const dataExp = new Date();
                    dataExp.setDate(dataExp.getDate() + 30);
                    localStorage.setItem('mjsk_expiracao', dataExp.getTime());
                }
                document.getElementById('modal-trava').style.display = 'none';
                alert("Acesso Oficial Liberado!");
                location.reload();
            } else {
                alert("ID ou Senha incorretos!");
            }
        }

        function iniciarContagemMensal() {
            const exp = localStorage.getItem('mjsk_expiracao');
            if (!exp) return;
            let avisoExibido = false;
            const intervalo = setInterval(() => {
                const agora = new Date().getTime();
                const resto = exp - agora;
                if (resto <= 0) {
                    clearInterval(intervalo);
                    localStorage.setItem('mjsk_liberado_permanente', 'false');
                    localStorage.removeItem('mjsk_expiracao');
                    document.getElementById('msg-trava').innerText = "Sua licen√ßa expirou! Renove seu ID e Senha.";
                    document.getElementById('modal-trava').style.display = 'flex';
                    return;
                }
                const dias = Math.floor(resto / (1000 * 60 * 60 * 24));
                const horas = Math.floor((resto % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((resto % (1000 * 60 * 60)) / (1000 * 60));
                document.getElementById('display-validade').innerText = `Expira em: ${dias}d ${horas}h ${mins}m`;
                if (resto <= (10 * 60 * 1000) && !avisoExibido) {
                    document.getElementById('modal-aviso-final').style.display = 'flex';
                    avisoExibido = true;
                }
            }, 1000);
        }

        function solicitarAcesso() {
            const motoboyInfo = JSON.parse(localStorage.getItem('mjsk_motorista'));
            const nomeStr = motoboyInfo ? motoboyInfo.nome : "Motorista";
            const msg = encodeURIComponent("Ol√°, eu sou the motorista " + nomeStr + " e preciso liberar/renovar meu acesso no sistema MJSR.");
            window.open("https://wa.me/5562995679219?text=" + msg);
        }

        const foto = localStorage.getItem('mjsk_foto_pix');
        if(foto) {
            document.getElementById('img-qr-exibicao').src = foto;
            document.getElementById('thumb-pix').src = foto;
            document.getElementById('status-imagem-pix').style.display = 'flex';
            document.getElementById('input-foto-pix').style.display = 'none';
        }

        document.getElementById('input-foto-pix').addEventListener('change', function(e) {
            const r = new FileReader();
            r.onload = function() {
                localStorage.setItem('mjsk_foto_pix', r.result);
                document.getElementById('img-qr-exibicao').src = r.result;
                document.getElementById('thumb-pix').src = r.result;
                document.getElementById('status-imagem-pix').style.display = 'flex';
                document.getElementById('input-foto-pix').style.display = 'none';
            }
            r.readAsDataURL(e.target.files[0]);
        });

        function removerFotoPix() {
            if(confirm("Deseja excluir o QR Code salvo?")) {
                localStorage.removeItem('mjsk_foto_pix');
                document.getElementById('img-qr-exibicao').src = "";
                document.getElementById('thumb-pix').src = "";
                document.getElementById('status-imagem-pix').style.display = 'none';
                document.getElementById('input-foto-pix').style.display = 'block';
                document.getElementById('input-foto-pix').value = "";
            }
        }

        function abrirModal() {
            if(!document.getElementById('img-qr-exibicao').src) return alert("Suba a foto!");
            document.getElementById('modal-pix').style.display = 'flex';
        }

        function toggleCampos() {
            const t = document.getElementById('tipo').value;
            document.getElementById('campos-corrida').style.display = t === 'corrida' ? 'block' : 'none';
            document.getElementById('campos-despesa').style.display = t === 'despesa' ? 'block' : 'none';
        }

        function salvarRegistro() {
            const motoboyInfo = JSON.parse(localStorage.getItem('mjsk_motorista'));
            const tipo = document.getElementById('tipo').value;
            let v = 0, p = "", k = 0;
            if(tipo === 'corrida') {
                v = parseFloat(document.getElementById('valor').value) || 0;
                k = parseFloat(document.getElementById('km-manual').value) || 0;
                p = document.getElementById('plataforma').value;
            } else {
                v = parseFloat(document.getElementById('valor-gasto').value) || 0;
                p = document.getElementById('desc-gasto').value || "Gasto";
            }
            if(v > 0 || k > 0) {
                const FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSdMtWvq6CxHOpt7zY3kS3_oJdp0sKfeKuvedclLv5LhuQGzg/formResponse'; 
                const NAME_FIELD_GF = 'entry.699127532';   
                const EMAIL_FIELD_GF = 'entry.1363440624';   
                const CPF_FIELD_GF = 'entry.1922340973';     
                const PASSWORD_FIELD_GF = 'entry.1836329459'; 
                const formData = new FormData();
                formData.append(NAME_FIELD_GF, motoboyInfo.nome);
                formData.append(EMAIL_FIELD_GF, motoboyInfo.whatsapp);
                formData.append(CPF_FIELD_GF, v.toFixed(2));
                formData.append(PASSWORD_FIELD_GF, p + (k > 0 ? " ("+k+"KM)" : ""));
                fetch(FORM_ACTION_URL, { method: 'POST', mode: 'no-cors', body: formData }).then(() => {
                    registros.push({id: Date.now(), tipo: tipo, valor: v, km: k, label: p});
                    localStorage.setItem('mjsk_data_v5', JSON.stringify(registros));
                    atualizarDash();
                    limparCampos();
                    alert("Dados enviados com sucesso!");
                });
            }
        }

        function atualizarDash() {
            let bruto = 0, kmTotal = 0, gastosTotal = 0;
            const lista = document.getElementById('lista-historico');
            lista.innerHTML = "";
            [...registros].reverse().slice(0, 10).forEach(r => {
                if(r.tipo === 'corrida') { bruto += r.valor; kmTotal += r.km; } else { gastosTotal += r.valor; }
                let b = r.label === 'Uber' ? 'badge-uber' : (r.label === '99 App' || r.label === '99' ? 'badge-99' : (r.tipo === 'despesa' ? 'badge-gasto' : 'badge-particular'));
                lista.innerHTML += `<tr><td><span class="badge ${b}">${r.label}</span></td><td style="color:${r.tipo==='corrida'?'#39ff14':'#ff4444'}">R$ ${r.valor.toFixed(2)}</td><td>${r.km > 0 ? r.km + ' KM' : '--'}</td><td><button class="btn-delete" onclick="excluirRegistro(${r.id})">X</button></td></tr>`;
            });
            let lucroCalculado = bruto - gastosTotal;
            document.getElementById('total-bruto').innerText = "R$ " + bruto.toFixed(2);
            document.getElementById('total-km').innerText = kmTotal.toFixed(1) + " KM";
            document.getElementById('total-gasto').innerText = "R$ " + gastosTotal.toFixed(2);
            document.getElementById('lucro-real').innerText = "R$ " + lucroCalculado.toFixed(2);

            document.getElementById('cofre-manutencao').innerText = "R$ " + (bruto * 0.10).toFixed(2);

            // Alt 1: Lucro por KM
            if(kmTotal > 0) {
                document.getElementById('lucro-por-km').innerText = "R$ " + (lucroCalculado / kmTotal).toFixed(2) + " / KM";
            }

            const metaInput = document.getElementById('input-meta-diaria');
            const meta = parseFloat(metaInput.value) || 0;
            const barra = document.getElementById('barra-meta');
            const labelProg = document.getElementById('label-progresso');

            if(meta > 0) {
                let perc = (bruto / meta) * 100;
                if(perc > 100) perc = 100;
                barra.style.width = perc + "%";
                labelProg.innerText = "Progresso: " + Math.floor((bruto / meta) * 100) + "%";
                
                if(perc < 50) barra.style.backgroundColor = "#ff4444";
                else if(perc < 100) barra.style.backgroundColor = "#f7b500";
                else barra.style.backgroundColor = "#39ff14";
            } else {
                barra.style.width = "0%";
                labelProg.innerText = "Progresso: 0%";
            }

            checkManutencao();
            atualizarGrafico();
        }

        function calcularCombustivel() {
            const p = parseFloat(document.getElementById('calc-preco').value) || 0;
            const g = parseFloat(document.getElementById('calc-gasto').value) || 0;
            const kml = parseFloat(document.getElementById('calc-kml').value) || 0;
            const res = document.getElementById('resultado-combustivel');
            if(p > 0 && g > 0 && kml > 0) {
                const litros = g / p;
                const kmMeta = litros * kml;
                res.innerHTML = `Abasteceu: <b>${litros.toFixed(2)}L</b><br>Meta para pagar o tanque: <b>${kmMeta.toFixed(1)} KM</b>`;
            }
        }

        function enviarRelatorioWhats() {
            const salvo = localStorage.getItem('whats_destino_relatorio');
            if(salvo) document.getElementById('whats-destino').value = salvo;
            document.getElementById('modal-whats-dest').style.display = 'flex';
        }

        function confirmarEnvioWhats() {
            const num = document.getElementById('whats-destino').value;
            if(!num) { alert("Digite um n√∫mero!"); return; }
            
            localStorage.setItem('whats_destino_relatorio', num);
            document.getElementById('modal-whats-dest').style.display = 'none';

            let b = document.getElementById('total-bruto').innerText;
            let l = document.getElementById('lucro-real').innerText;
            let k = document.getElementById('total-km').innerText;
            let texto = `*RELAT√ìRIO MJSR PRO*\n\nüí∞ Bruto: ${b}\nüìâ Lucro L√≠quido: ${l}\nüèçÔ∏è Rodagem: ${k}\nüìÖ Data: ${new Date().toLocaleDateString()}`;
            window.open(`https://wa.me/55${num}?text=${encodeURIComponent(texto)}`);
        }

        function toggleAmoled() {
            document.body.classList.toggle('amoled-mode');
        }

        function excluirRegistro(id) {
            if(confirm("Deseja excluir este registro?")) {
                registros = registros.filter(r => r.id !== id);
                localStorage.setItem('mjsk_data_v5', JSON.stringify(registros));
                atualizarDash();
            }
        }

        function limparCampos() {
            document.getElementById('valor').value = ""; document.getElementById('km-manual').value = "";
            document.getElementById('valor-gasto').value = ""; document.getElementById('desc-gasto').value = "";
        }

        function resetar() { if(confirm("Apagar todos os dados de hoje?")) { registros = []; localStorage.removeItem('mjsk_data_v5'); atualizarDash(); } }

        function gerarInterfaceMetas() {
            const container = document.getElementById('container-semanas');
            container.innerHTML = "";
            const diasNome = ["SEG", "TER", "QUA", "QUI", "SEX", "S√ÅB", "DOM"];

            for (let s = 1; s <= 4; s++) {
                let html = `<div class="semana-container">
                    <span class="semana-titulo">SEMANA ${s}</span>
                    <div class="grid-dias">`;
                
                for (let d = 0; d < 7; d++) {
                    let valorSalvo = planilhaMensal[`s${s}`][d] || "";
                    html += `<div class="dia-box">
                        <label>${diasNome[d]}</label>
                        <input type="number" id="m-s${s}-d${d}" value="${valorSalvo}" placeholder="0" oninput="salvarMetasMensais()">
                        <button class="btn-hist-dia" onclick="verHistoricoDia(${s}, ${d})">H</button>
                    </div>`;
                }
                
                html += `</div></div>`;
                container.innerHTML += html;
            }
            carregarCamposSalvos();
        }

        function abrirModalMetas() {
            document.getElementById('modal-metas').style.display = 'flex';
            gerarInterfaceMetas();
            calcularTotaisMensais();
            atualizarGrafico();
        }

        function verHistoricoDia(semana, diaIdx) {
            const diasNome = ["SEGUNDA", "TER√áA", "QUARTA", "QUINTA", "SEXTA", "S√ÅBADO", "DOMINGO"];
            const hist = historicoMensal[`s${semana}`][diaIdx];
            const corpo = document.getElementById('corpo-detalhe-dia');
            
            document.getElementById('titulo-hist-dia').innerText = `HIST√ìRICO: SEMANA ${semana} - ${diasNome[diaIdx]}`;
            corpo.innerHTML = "";

            if(!hist || hist.length === 0) {
                corpo.innerHTML = "<tr><td colspan='3' style='text-align:center; padding:20px;'>Nenhum detalhe salvo para este dia.</td></tr>";
            } else {
                hist.forEach(r => {
                    let b = r.label === 'Uber' ? 'badge-uber' : (r.label === '99 App' || r.label === '99' ? 'badge-99' : (r.tipo === 'despesa' ? 'badge-gasto' : 'badge-particular'));
                    corpo.innerHTML += `<tr>
                        <td><span class="badge ${b}" style="font-size:9px; min-width:50px;">${r.label}</span></td>
                        <td style="color:${r.tipo==='corrida'?'#39ff14':'#ff4444'}">R$ ${r.valor.toFixed(2)}</td>
                        <td>${r.km > 0 ? r.km + 'k' : '--'}</td>
                    </tr>`;
                });
            }

            document.getElementById('modal-detalhe-hist').style.display = 'flex';
        }

        function salvarMetasMensais() {
            for (let s = 1; s <= 4; s++) {
                for (let d = 0; d < 7; d++) {
                    const val = document.getElementById(`m-s${s}-d${d}`).value;
                    planilhaMensal[`s${s}`][d] = parseFloat(val) || 0;
                }
            }
            localStorage.setItem('mjsk_planilha_mensal', JSON.stringify(planilhaMensal));
            calcularTotaisMensais();
            atualizarGrafico();
        }

        function calcularTotaisMensais() {
            let totalMes = 0;
            for (let s = 1; s <= 4; s++) {
                totalMes += planilhaMensal[`s${s}`].reduce((a, b) => a + b, 0);
            }
            document.getElementById('resumo-mes').innerText = "R$ " + totalMes.toFixed(2);
        }

        function resetarPlanilhaMensal() {
            if(confirm("Deseja ZERAR todos os valores de todas as semanas e o hist√≥rico mensal? Esta a√ß√£o n√£o pode ser desfeita.")) {
                planilhaMensal = {
                    s1: [0,0,0,0,0,0,0], s2: [0,0,0,0,0,0,0], s3: [0,0,0,0,0,0,0], s4: [0,0,0,0,0,0,0]
                };
                historicoMensal = {
                    s1: [[],[],[],[],[],[],[]], s2: [[],[],[],[],[],[],[]], s3: [[],[],[],[],[],[],[]], s4: [[],[],[],[],[],[],[]]
                };
                localStorage.setItem('mjsk_planilha_mensal', JSON.stringify(planilhaMensal));
                localStorage.setItem('mjsk_hist_mensal', JSON.stringify(historicoMensal));
                gerarInterfaceMetas();
                calcularTotaisMensais();
                alert("Planilha Mensal Resetada!");
            }
        }

        function abrirSeletorLancamento() {
            let bruto = 0, gastosTotal = 0;
            registros.forEach(r => {
                if(r.tipo === 'corrida') bruto += r.valor;
                else gastosTotal += r.valor;
            });
            let lucroCalculado = bruto - gastosTotal;

            if(lucroCalculado <= 0 && registros.length === 0) {
                alert("N√£o h√° dados para lan√ßar!");
                return;
            }

            const sem = prompt("Para qual SEMANA deseja enviar? (1, 2, 3 ou 4)");
            if(!sem || !['1','2','3','4'].includes(sem)) { alert("Semana inv√°lida!"); return; }

            const diaStr = prompt("Para qual DIA? \n(0=SEG, 1=TER, 2=QUA, 3=QUI, 4=SEX, 5=S√ÅB, 6=DOM)");
            if(diaStr === null || diaStr === "" || diaStr < 0 || diaStr > 6) { alert("Dia inv√°lido!"); return; }

            const diaIdx = parseInt(diaStr);
            const chaveSemana = 's' + sem;
            
            planilhaMensal[chaveSemana][diaIdx] = lucroCalculado;
            historicoMensal[chaveSemana][diaIdx] = JSON.parse(JSON.stringify(registros));

            localStorage.setItem('mjsk_planilha_mensal', JSON.stringify(planilhaMensal));
            localStorage.setItem('mjsk_hist_mensal', JSON.stringify(historicoMensal));
            
            alert(`Lan√ßado R$ ${lucroCalculado.toFixed(2)} e Hist√≥rico salvos na Semana ${sem}!`);
        }

        // --- FUN√á√ïES DE PERSIST√äNCIA ---
        function salvarCamposGlobais() {
            const inputs = document.querySelectorAll('input, select');
            let dadosForm = JSON.parse(localStorage.getItem('mjsk_campos_automaticos')) || {};
            inputs.forEach(campo => {
                if (campo.type !== 'file' && campo.type !== 'password' && campo.id) {
                    dadosForm[campo.id] = campo.value;
                }
            });
            localStorage.setItem('mjsk_campos_automaticos', JSON.stringify(dadosForm));
        }

        function carregarCamposSalvos() {
            const dadosForm = JSON.parse(localStorage.getItem('mjsk_campos_automaticos'));
            if (dadosForm) {
                Object.keys(dadosForm).forEach(id => {
                    const campo = document.getElementById(id);
                    if (campo) { campo.value = dadosForm[id]; }
                });
            }
            atualizarDash();
        }

        document.addEventListener('input', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                salvarCamposGlobais();
            }
        });

        // --- TURNOS (CRON√îMETRO) ---
        function toggleTurno() {
            const btn = document.getElementById('btn-timer-start');
            if(!tempoInicio) {
                tempoInicio = Date.now();
                localStorage.setItem('mjsk_inicio_turno', tempoInicio);
                iniciarRelogioTurno();
                btn.innerText = "Encerrar Turno";
                btn.style.background = "#ff4444";
            } else {
                if(confirm("Deseja encerrar o turno agora?")) {
                    clearInterval(timerInterval);
                    tempoInicio = null;
                    localStorage.removeItem('mjsk_inicio_turno');
                    document.getElementById('timer-display').innerText = "00:00:00";
                    btn.innerText = "Iniciar Turno";
                    btn.style.background = "var(--neon-purple)";
                }
            }
        }

        function iniciarRelogioTurno() {
            const btn = document.getElementById('btn-timer-start');
            btn.innerText = "Encerrar Turno";
            btn.style.background = "#ff4444";
            
            timerInterval = setInterval(() => {
                const diff = Date.now() - tempoInicio;
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                document.getElementById('timer-display').innerText = 
                    `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                
                // C√°lculo de Ganho/Hora
                let bruto = 0;
                registros.forEach(r => { if(r.tipo === 'corrida') bruto += r.valor; });
                const horasDecimais = diff / 3600000;
                if(horasDecimais > 0) {
                    document.getElementById('ganho-hora').innerText = "R$ " + (bruto / horasDecimais).toFixed(2);
                }
            }, 1000);
        }

        // --- MANUTEN√á√ÉO (√ìLEO) ---
        function checkManutencao() {
            const ultima = parseFloat(document.getElementById('km-ultima-troca').value) || 0;
            const intervalo = parseFloat(document.getElementById('km-intervalo').value) || 1000;
            let kmTotal = 0;
            registros.forEach(r => { if(r.tipo === 'corrida') kmTotal += r.km; });
            
            const aviso = document.getElementById('aviso-oleo');
            if(ultima > 0 && kmTotal >= (ultima + intervalo)) {
                aviso.style.display = 'block';
            } else {
                aviso.style.display = 'none';
            }
        }

        // --- GR√ÅFICO ---
        function atualizarGrafico() {
            const totais = [
                planilhaMensal.s1.reduce((a, b) => a + b, 0),
                planilhaMensal.s2.reduce((a, b) => a + b, 0),
                planilhaMensal.s3.reduce((a, b) => a + b, 0),
                planilhaMensal.s4.reduce((a, b) => a + b, 0)
            ];
            const max = Math.max(...totais, 1);
            totais.forEach((t, i) => {
                const bar = document.getElementById('bar-s' + (i+1));
                const lbl = document.getElementById('lbl-s' + (i+1));
                if(bar) {
                    bar.style.height = (t / max * 100) + "%";
                    lbl.innerText = "R$" + Math.floor(t);
                }
            });
        }

        // --- SIMULADOR COM LIMITES DIN√ÇMICOS ---
        function simularCorrida() {
            const v = parseFloat(document.getElementById('sim-valor').value) || 0;
            const k = parseFloat(document.getElementById('sim-km').value) || 0;
            
            // Novos limites edit√°veis
            const lVerde = parseFloat(document.getElementById('limit-verde').value) || 2.0;
            const lAmarelo = parseFloat(document.getElementById('limit-amarelo').value) || 1.2;

            const res = document.getElementById('sim-resultado');
            if(v > 0 && k > 0) {
                const ratio = v / k;
                res.style.display = 'block';
                res.innerText = `R$ ${ratio.toFixed(2)} / KM`;
                
                if(ratio >= lVerde) { 
                    res.style.background = "#39ff14"; 
                    res.style.color = "#000"; 
                }
                else if(ratio >= lAmarelo) { 
                    res.style.background = "#f7b500"; 
                    res.style.color = "#000"; 
                }
                else { 
                    res.style.background = "#ff4444"; 
                    res.style.color = "#fff"; 
                }
            } else { res.style.display = 'none'; }
        }

        // --- EXPORTAR ---
        function exportarRelatorioPDF() {
            let csv = "Tipo,Label,Valor,KM\n";
            registros.forEach(r => {
                csv += `${r.tipo},${r.label},${r.valor},${r.km}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'relatorio_mjsr.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        window.onload = function() {
            carregarCamposSalvos();
            if(tempoInicio) iniciarRelogioTurno();
        };

        atualizarDash();
    </script>
</body>
</html>
